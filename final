<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Complete Attendance System (Auto Multi-Face Recognize)</title>
    <style>
      /* === YOUR ORIGINAL STYLES (unchanged) === */
      body {
        font-family: Arial, Helvetica, sans-serif;
        margin: 0;
        padding: 0;
        text-align: center;
        background: url("blog-33-Importance-of-Student-Attendance-in-Education.jpg")
          no-repeat center center fixed;
        background-size: cover;
        color: #fff;
      }
      body::before {
        content: "";
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.55);
        z-index: -1;
      }
      button {
        background-color: #04aa6d;
        color: white;
        padding: 14px 20px;
        margin: 8px;
        border: none;
        cursor: pointer;
        width: auto;
        font-size: 16px;
        border-radius: 6px;
        transition: 0.3s;
      }
      button:hover {
        opacity: 0.9;
        transform: scale(1.05);
      }
      .modal {
        display: none;
        position: fixed;
        z-index: 100;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background: rgba(0, 0, 0, 0.6);
        padding-top: 60px;
        transition: all 0.25s ease-in-out;
      }
      .modal.active {
        display: block;
        opacity: 1;
      }
      .modal-content {
        background: #fff;
        margin: 5% auto;
        border-radius: 12px;
        padding: 20px;
        width: 90%;
        max-width: 500px;
        position: relative;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
        color: #000;
      }
      .close {
        position: absolute;
        right: 20px;
        top: 10px;
        font-size: 30px;
        font-weight: bold;
        cursor: pointer;
        color: #333;
      }
      input,
      select {
        width: 100%;
        padding: 10px;
        margin: 5px 0;
        border: 1px solid #ccc;
        border-radius: 6px;
        box-sizing: border-box;
      }
      #cameraSection {
        text-align: center;
        margin-top: 10px;
      }
      video,
      canvas {
        width: 100%;
        max-width: 300px;
        border-radius: 8px;
        margin-top: 10px;
        object-fit: cover;
      }

      /* Navbar */
      .navbar {
        background: linear-gradient(90deg, #0062ff, #00c6ff);
        padding: 10px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        color: #fff;
      }
      .logout-btn {
        background: #ff4757;
        border: none;
        padding: 8px 15px;
        border-radius: 8px;
        color: #fff;
        cursor: pointer;
      }
      .logout-btn:hover {
        background: #e84118;
      }

      /* Dashboard */
      .dashboard-container {
        display: flex;
        height: calc(100vh - 50px);
      }
      .sidebar {
        width: 300px;
        background: #fff;
        border-right: 1px solid #ddd;
        overflow-y: auto;
        padding: 20px;
        color: #000;
      }
      .student-list {
        margin-top: 10px;
      }
      .student-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px;
        border-radius: 10px;
        cursor: pointer;
        transition: 0.3s;
        border: 1px solid #ccc;
        margin-bottom: 5px;
      }
      .student-item:hover {
        background: #e9f2ff;
      }
      .student-item.active {
        background: #0062ff;
        color: #fff;
      }

      .main-content {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
      }
      .student-details {
        background: #fff;
        border-radius: 12px;
        padding: 15px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
        color: #000;
      }
      .subject-header {
        background: #00c6ff;
        color: #fff;
        padding: 8px 12px;
        border-radius: 8px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        font-weight: 600;
        margin-bottom: 5px;
      }
      .attendance-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 10px;
        display: none;
      }
      .attendance-table th,
      .attendance-table td {
        border: 1px solid #ccc;
        padding: 5px;
        text-align: center;
      }
      .present {
        background: #c8e6c9;
      }
      .absent {
        background: #ffcdd2;
      }

      /* overlay canvas (we'll position it inside modal near video) */
      #overlayCanvas {
        background: #00000000 !important;
        top: -341px;
        position: relative;
      }

      /* ================== Purple-Blue Accent + Medium Neutral Gray (CSS-only override) ================== */
      :root {
        --accent-1: #6a5cf6; /* bold purple-blue */
        --accent-2: #4f46e5; /* deeper accent */
        --accent-3: #8a92ff; /* hover/outline */
        --text: #f2f4f8; /* off-white */
        --muted: #b2b8c6; /* secondary text */
        --g-900: #111317; /* page background (dark neutral gray) */
        --g-850: #151922;
        --g-800: #1b202b; /* cards/panels */
        --g-700: #242b38; /* inputs/rows */
        --g-600: #2f3747; /* borders */
        --g-500: #6b7280; /* medium neutral gray (requested) */
        --shadow: 0 12px 28px rgba(0, 0, 0, 0.45),
          inset 0 1px 0 rgba(255, 255, 255, 0.04);
        --r-lg: 16px;
        --r-md: 12px;
        --r-sm: 10px;
        --speed: 260ms;
      }
      body {
        color: var(--text) !important;
        background: radial-gradient(
            1000px 600px at 12% -10%,
            rgba(106, 92, 246, 0.1),
            transparent 60%
          ),
          radial-gradient(
            900px 700px at 100% 0%,
            rgba(79, 70, 229, 0.1),
            transparent 55%
          ),
          linear-gradient(180deg, var(--g-900), var(--g-850)) !important;
      }
      body::before {
        filter: grayscale(100%) brightness(0.55) contrast(1.08) !important;
        mix-blend-mode: luminosity !important;
      }

      /* Navbar */
      .navbar {
        background: linear-gradient(
          90deg,
          var(--accent-2),
          var(--accent-1)
        ) !important;
        border-bottom: 1px solid rgba(255, 255, 255, 0.08) !important;
        box-shadow: var(--shadow) !important;
      }
      .logout-btn {
        background: transparent !important;
        color: #fff !important;
        border: 1px solid rgba(255, 255, 255, 0.28) !important;
        border-radius: 12px !important;
        padding: 10px 16px !important;
        box-shadow: 0 10px 24px rgba(0, 0, 0, 0.3) !important;
      }
      .logout-btn:hover {
        background: rgba(255, 255, 255, 0.12) !important;
      }

      /* Buttons */
      button {
        background: linear-gradient(
          180deg,
          var(--accent-1),
          var(--accent-2)
        ) !important;
        color: #fff !important;
        font-weight: 800 !important;
        letter-spacing: 0.2px !important;
        border: 1px solid rgba(255, 255, 255, 0.14) !important;
        border-radius: var(--r-sm) !important;
        box-shadow: 0 14px 32px rgba(106, 92, 246, 0.35),
          0 0 0 1px rgba(255, 255, 255, 0.06) inset !important;
        position: relative;
        overflow: hidden;
        transition: transform var(--speed), filter var(--speed),
          box-shadow var(--speed) !important;
      }
      button::after {
        content: "";
        position: absolute;
        top: 0;
        left: -150%;
        width: 140%;
        height: 100%;
        background: linear-gradient(
          110deg,
          rgba(255, 255, 255, 0) 0%,
          rgba(255, 255, 255, 0.35) 50%,
          rgba(255, 255, 255, 0) 100%
        );
        transform: skewX(-20deg);
        transition: left 900ms ease;
      }
      button:hover {
        transform: translateY(-1px) scale(1.02) !important;
        filter: brightness(1.06) !important;
      }
      button:hover::after {
        left: 110%;
      }
      #homeButtons button:last-of-type {
        background: linear-gradient(
          90deg,
          var(--accent-2),
          var(--accent-1)
        ) !important;
        box-shadow: 0 18px 36px rgba(79, 70, 229, 0.45) !important;
      }

      /* Intro paragraph */
      #homeButtons p {
        color: var(--muted) !important;
        background: rgba(255, 255, 255, 0.06) !important;
        border: 1px solid rgba(255, 255, 255, 0.12) !important;
        border-radius: var(--r-md) !important;
        padding: 12px 16px !important;
        display: inline-block;
        backdrop-filter: blur(6px);
        -webkit-backdrop-filter: blur(6px);
      }

      /* Modals */
      .modal {
        background: rgba(14, 16, 22, 0.68) !important;
        z-index: 1000 !important;
      }
      .modal-content {
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.1),
          rgba(255, 255, 255, 0.06)
        ) !important;
        color: var(--text) !important;
        border: 1px solid rgba(255, 255, 255, 0.12) !important;
        border-radius: var(--r-lg) !important;
        box-shadow: var(--shadow) !important;
      }
      .close {
        color: #ececff !important;
      }
      .close:hover {
        color: #fff !important;
      }

      /* Inputs */
      input,
      select {
        background: var(--g-700) !important;
        color: var(--text) !important;
        border: 1px solid var(--g-600) !important;
        border-radius: 12px !important;
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.04) !important;
      }
      input::placeholder {
        color: var(--g-500) !important;
      }
      input:focus,
      select:focus {
        outline: none !important;
        border-color: var(--accent-3) !important;
        box-shadow: 0 0 0 3px rgba(138, 146, 255, 0.35) !important;
      }

      /* Panels / cards */
      .sidebar {
        background: var(--g-800) !important;
        color: var(--text) !important;
        border-right: 1px solid var(--g-600) !important;
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
      }
      .main-content {
        color: var(--text) !important;
      }
      .student-details {
        background: var(--g-800) !important;
        color: var(--text) !important;
        border: 1px solid var(--g-600) !important;
        border-radius: var(--r-lg) !important;
        box-shadow: var(--shadow) !important;
      }

      /* Student list */
      .student-item {
        background: rgba(255, 255, 255, 0.05) !important;
        border: 1px solid var(--g-600) !important;
        border-radius: 14px !important;
        transition: transform var(--speed), background var(--speed),
          box-shadow var(--speed) !important;
      }
      .student-item:hover {
        background: rgba(122, 131, 255, 0.1) !important;
        transform: translateY(-1px) !important;
        box-shadow: 0 12px 26px rgba(79, 70, 229, 0.32) !important;
      }
      .student-item.active {
        background: linear-gradient(
          90deg,
          rgba(122, 131, 255, 0.25),
          rgba(79, 70, 229, 0.2)
        ) !important;
        color: #fff !important;
        border-color: transparent !important;
      }

      /* Subject headers */
      .subject-header {
        background: linear-gradient(
          90deg,
          var(--accent-2),
          var(--accent-1)
        ) !important;
        color: #fff !important;
        border: 1px solid rgba(255, 255, 255, 0.14) !important;
        border-radius: 12px !important;
        font-weight: 800 !important;
        box-shadow: 0 10px 24px rgba(79, 70, 229, 0.4),
          inset 0 0 0 1px rgba(255, 255, 255, 0.06) !important;
      }

      /* Tables */
      .attendance-table {
        background: var(--g-800) !important;
        border: 1px solid var(--g-600) !important;
        border-radius: 12px !important;
        overflow: hidden;
        box-shadow: var(--shadow) !important;
      }
      .attendance-table th,
      .attendance-table td {
        color: var(--text) !important;
        border-bottom: 1px solid rgba(255, 255, 255, 0.06) !important;
      }
      .attendance-table thead th {
        background: rgba(255, 255, 255, 0.06) !important;
      }
      .attendance-table tbody tr:hover {
        background: rgba(122, 131, 255, 0.08) !important;
      }

      /* Status chips */
      .present {
        background: rgba(122, 131, 255, 0.16) !important;
        color: #fff !important;
      }
      .absent {
        background: rgba(107, 114, 128, 0.28) !important;
        color: #e8eaf2 !important;
      }

      /* Camera visibility & sizing */
      #cameraSection {
        position: relative;
        z-index: 1002;
      }
      video,
      canvas {
        display: block !important;
        width: min(92vw, 440px) !important;
        max-width: 100% !important;
        aspect-ratio: 4/3 !important;
        min-height: 240px !important;
        background: #0e1220 !important;
        border: 1px solid rgba(122, 131, 255, 0.32) !important;
        border-radius: 16px !important;
        box-shadow: 0 14px 36px rgba(0, 0, 0, 0.45) !important;
      }

      /* Scrollbars */
      .sidebar,
      .main-content,
      .modal {
        scrollbar-width: thin;
        scrollbar-color: var(--g-500) rgba(255, 255, 255, 0.06);
      }
      .sidebar::-webkit-scrollbar,
      .main-content::-webkit-scrollbar,
      .modal::-webkit-scrollbar {
        width: 10px;
      }
      .sidebar::-webkit-scrollbar-thumb,
      .main-content::-webkit-scrollbar-thumb,
      .modal::-webkit-scrollbar-thumb {
        background: linear-gradient(180deg, #a0a6b8, #6b7280);
        border-radius: 20px;
      }
      .sidebar::-webkit-scrollbar-track,
      .main-content::-webkit-scrollbar-track,
      .modal::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.06);
        border-radius: 20px;
      }

      /* Motion preferences */
      @media (prefers-reduced-motion: reduce) {
        * {
          transition: none !important;
          animation: none !important;
        }
      }
    </style>
  </head>
  <body>
    <div class="navbar">
      <span>Face Recognition Attendance System</span>
      <button class="logout-btn" onclick="logout()">Logout</button>
    </div>

    <!-- HOME -->
    <div id="homeButtons">
      <h2>Welcome to Face Recognition Attendance System</h2>
      <p>
        Students: Register/Login | Admin: Login | Admin can also mark attendance
        via face capture
      </p>
      <br />
      <button onclick="showModal('registerModal')">Register</button>
      <button onclick="showModal('studentLoginModal')">Student Login</button>
      <button onclick="showModal('adminLoginModal')">Admin Login</button>
    </div>

    <!-- REGISTER MODAL -->
    <div id="registerModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeModal('registerModal')">&times;</span>
        <h2>Student Registration</h2>
        <input type="text" id="regUname" placeholder="Username" required />
        <input type="password" id="regPsw" placeholder="Password" required />
        <input type="text" id="regName" placeholder="Full Name" required />
        <input type="text" id="regUsn" placeholder="USN" required />
        <input type="email" id="regEmail" placeholder="Email" required />
        <input type="tel" id="regPhone" placeholder="Phone" required />
        <select id="regCourse">
          <option value="">Course</option>
          <option>CSE</option>
          <option>CSD</option>
          <option>AIML</option>
          <option>ECE</option>
          <option>EEE</option>
          <option>ME</option>
          <option>CIVIL</option>
        </select>
        <select id="regSem">
          <option value="">Semester</option>
          <option>1</option>
          <option>2</option>
          <option>3</option>
          <option>4</option>
          <option>5</option>
          <option>6</option>
          <option>7</option>
          <option>8</option>
        </select>
        <div id="cameraSection">
          <button type="button" onclick="openCamera('regVideo')">
            üì∑ Open Camera</button
          ><br />
          <video id="regVideo" autoplay muted></video>
          <canvas id="regCanvas"></canvas><br />
          <button type="button" onclick="captureRegistrationPhoto()">
            üì∏ Capture
          </button>
          <p style="font-size: 12px; color: #333">
            (Capture during registration ‚Äî required for recognition)
          </p>
        </div>
        <button onclick="registerStudent()">Register</button>
      </div>
    </div>

    <!-- STUDENT LOGIN -->
    <div id="studentLoginModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeModal('studentLoginModal')"
          >&times;</span
        >
        <h4>Student Login</h4>
        <input id="studentLoginUSN" placeholder="USN" />
        <input id="studentLoginPass" placeholder="Password" type="password" />
        <button onclick="studentLogin()">Login</button>
      </div>
    </div>

    <!-- ADMIN LOGIN -->
    <div id="adminLoginModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeModal('adminLoginModal')"
          >&times;</span
        >
        <h4>Admin Login</h4>
        <input id="adminUser" placeholder="Username" />
        <input id="adminPwd" placeholder="Password" type="password" />
        <button onclick="adminLogin()">Login</button>
        <p>Default: <b>admin / admin123</b></p>
      </div>
    </div>

    <!-- ADMIN CAPTURE -->
    <div id="adminCaptureModal" class="modal">
      <div class="modal-content" style="position: relative">
        <span class="close" onclick="closeAdminCaptureModal()">&times;</span>
        <h4>Mark Attendance via Face (Automatic Multi-Face)</h4>

        <input
          id="adminStudentUSN"
          placeholder="(Optional fallback) Enter Student USN"
        />
        <label
          >Subject:
          <select id="adminAttSubject">
            <option>SEPM</option>
            <option>RMIPR</option>
            <option>EVS</option>
            <option>AI</option>
            <option>CN</option>
            <option>TOC</option>
            <option>PE</option>
            <option>TP</option>
          </select>
        </label>
        <label
          >Period:
          <input
            id="adminAttPeriod"
            placeholder="1"
            style="width: 60px" /></label
        ><br /><br />

        <div id="cameraSection">
          <button type="button" onclick="openCamera('adminVideo')">
            üì∑ Open Camera</button
          ><br />
          <video id="adminVideo" autoplay muted></video>
          <canvas id="overlayCanvas"></canvas>
          <br />
          <div style="margin-top: 8px">
            <button type="button" onclick="forceRecognizeNow()">
              üîÅ Force Recognize Now
            </button>
            <span
              id="faceStatus"
              style="font-size: 13px; color: #333; margin-left: 10px"
            ></span>
          </div>
        </div>
      </div>
    </div>

    <!-- DASHBOARDS -->
    <div id="studentDashboard" style="display: none">
      <div class="main-content text-center">
        <h3>Your Dashboard</h3>
        <div id="studentInfo" class="student-details text-center"></div>
        <div class="student-details">
          <h5>Your Attendance</h5>
          <div id="studentAttendance"></div>
        </div>
      </div>
    </div>

    <div id="adminDashboard" style="display:none; flex;">
      <div class="sidebar">
        <button onclick="showModal('adminCaptureModal')">
          üì∑ Mark Attendance (Admin)
        </button>
        <h4>Students</h4>
        <input
          id="searchInput"
          placeholder="Search student..."
          onkeyup="searchStudent()"
        />
        <div id="studentList" class="student-list"></div>
      </div>

      <div class="main-content">
        <div id="adminStudentDetails" class="student-details text-center">
          
          <h5>Select a student to view attendance</h5>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

    <script>
      /* ===================== original JS , plus fixed recognition integration) ===================== */

      /* ===================== Data storage (localStorage) ===================== */
      const STORAGE_KEY = "attendance_students_v1";
      let studentData = {}; // keyed by USN
      loadStudentData();
      function loadStudentData() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          studentData = raw ? JSON.parse(raw) : {};
        } catch (e) {
          studentData = {};
        }
      }
      function saveStudentData() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(studentData));
      }

      /* ===================== Face-api models ===================== */
      const MODEL_URL =
        "https://justadudewhohacks.github.io/face-api.js/models";
      let modelsLoaded = false;
      async function loadFaceModels() {
        try {
          await Promise.all([
            faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
            faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
            faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL),
          ]);
          modelsLoaded = true;
          console.log("face models loaded");
        } catch (err) {
          console.error("model load err", err);
          alert("Failed to load face models from CDN. Check network.");
        }
      }
      loadFaceModels();

      /* ===================== Camera stream ===================== */
      let GLOBAL_STREAM = null;
      async function openCamera(videoId) {
        try {
          const video = document.getElementById(videoId);
          if (GLOBAL_STREAM) {
            video.srcObject = GLOBAL_STREAM;
            return;
          }
          GLOBAL_STREAM = await navigator.mediaDevices.getUserMedia({
            video: true,
            audio: false,
          });
          document.querySelectorAll("video").forEach((v) => {
            v.srcObject = GLOBAL_STREAM;
          });
        } catch (err) {
          alert("Camera error: " + err);
          console.error(err);
        }
      }

      /* capture registration photo */
      function captureRegistrationPhoto() {
        const data = capturePhotoToCanvas("regVideo", "regCanvas");
        window.lastCapturedImage = data;
        alert("Photo Captured!");
      }
      function capturePhotoToCanvas(videoId, canvasId) {
        const video = document.getElementById(videoId);
        const canvas = document.getElementById(canvasId);
        const ctx = canvas.getContext("2d");
        const w = video.videoWidth || 320;
        const h = video.videoHeight || 240;
        canvas.width = w;
        canvas.height = h;
        ctx.drawImage(video, 0, 0, w, h);
        return canvas.toDataURL("image/png");
      }

      /* ===================== Registration ===================== */
      async function registerStudent() {
        const uname = document.getElementById("regUname").value.trim();
        const pass = document.getElementById("regPsw").value.trim();
        const name = document.getElementById("regName").value.trim();
        const usn = document.getElementById("regUsn").value.trim();
        const email = document.getElementById("regEmail").value.trim();
        const phone = document.getElementById("regPhone").value.trim();
        const course = document.getElementById("regCourse").value;
        const sem = document.getElementById("regSem").value;
        if (
          !uname ||
          !pass ||
          !name ||
          !usn ||
          !email ||
          !phone ||
          !course ||
          !sem
        ) {
          alert("Fill all fields & capture photo");
          return;
        }
        const regCanvas = document.getElementById("regCanvas");
        if (!regCanvas || !regCanvas.width) {
          alert("Please capture a photo first");
          return;
        }
        if (!modelsLoaded) {
          alert("Face models loading ‚Äî wait a moment and retry");
          return;
        }

        try {
          const dataUrl = regCanvas.toDataURL("image/png");
          const img = await faceapi.fetchImage(dataUrl);
          const detection = await faceapi
            .detectSingleFace(img, new faceapi.TinyFaceDetectorOptions())
            .withFaceLandmarks()
            .withFaceDescriptor();
          if (!detection) {
            alert("No face detected ‚Äî recapture with good lighting");
            return;
          }
          const descriptor = Array.from(detection.descriptor);
          studentData[usn] = {
            uname,
            pass,
            name,
            usn,
            email,
            phone,
            course,
            semester: sem,
            photo: dataUrl,
            descriptor,
            subjects: {
              SEPM: [],
              RMIPR: [],
              EVS: [],
              AI: [],
              CN: [],
              TOC: [],
              PE: [],
              TP: [],
            },
          };
          saveStudentData();
          alert("Registered Successfully! Face saved.");
          closeModal("registerModal");
        } catch (e) {
          console.error(e);
          alert("Error registering face ‚Äî try again.");
        }
      }

      /* ===================== Student login ===================== */
      let currentStudent = null;
      function studentLogin() {
        const usn = document.getElementById("studentLoginUSN").value.trim();
        const pass = document.getElementById("studentLoginPass").value.trim();
        if (studentData[usn] && studentData[usn].pass === pass) {
          currentStudent = usn;
          document.getElementById("homeButtons").style.display = "none";
          document.getElementById("studentDashboard").style.display = "block";
          showStudentInfo();
          closeModal("studentLoginModal");
        } else alert("Invalid credentials!");
      }
      function showStudentInfo() {
        const s = studentData[currentStudent];
        document.getElementById(
          "studentInfo"
        ).innerHTML = `<img src="${s.photo}" style="width:100px;border-radius:50%;"><h4>${s.name}</h4>
    <p><b>Username:</b> ${s.uname} | <b>USN:</b> ${s.usn} | <b>Email:</b> ${s.email}<br><b>Phone:</b> ${s.phone} | <b>Course:</b> ${s.course} | <b>Sem:</b> ${s.semester}</p>`;
        renderAttendance();
      }
      function renderAttendance() {
        const s = studentData[currentStudent];
        let html = "";
        for (const [sub, records] of Object.entries(s.subjects)) {
          html += `<div><div class="subject-header" onclick="toggleSubject(this)">${sub} ‚ñº</div>
      <table class="attendance-table"><thead><tr><th>Date</th><th>Time</th><th>PEriod</th><th>Status</th></tr></thead>
      <tbody>${records
        .map(
          (r) =>
            `<tr class="${r.status === "Present" ? "present" : "absent"}"><td>${
              r.date
            }</td><td>${r.time}</td><td>${r.period}</td><td>${
              r.status
            }</td></tr>`
        )
        .join("")}</tbody></table></div>`;
        }
        document.getElementById("studentAttendance").innerHTML = html;
        document
          .querySelectorAll(".attendance-table")
          .forEach((t) => (t.style.display = "none"));
      }
      function toggleSubject(h) {
        const t = h.nextElementSibling;
        t.style.display =
          t.style.display === "none" || t.style.display === ""
            ? "table"
            : "none";
      }

      /* ===================== Admin login ===================== */
      function adminLogin() {
        const u = document.getElementById("adminUser").value.trim();
        const p = document.getElementById("adminPwd").value.trim();
        if (u === "admin" && p === "admin123") {
          document.getElementById("homeButtons").style.display = "none";
          document.getElementById("adminDashboard").style.display = "flex";
          loadStudentList();
          closeModal("adminLoginModal");
          alert("Admin login successful!");
        } else alert("Invalid admin login!");
      }

      /* ===================== Face recognition helpers ===================== */
      function buildLabeledDescriptors() {
        const labeled = [];
        for (const usn of Object.keys(studentData)) {
          const s = studentData[usn];
          if (s && s.descriptor && Array.isArray(s.descriptor)) {
            const f = new Float32Array(s.descriptor);
            labeled.push(new faceapi.LabeledFaceDescriptors(usn, [f]));
          }
        }
        return labeled;
      }

      /* ===================== Admin Multi-face recognition ===================== */
      let recognitionRunning = false;
      let recognitionAnimationId = null;
      let faceMatcher = null;
      let sessionMarked = new Set();

      async function startRecognitionLoop() {
        if (recognitionRunning) return;
        if (!modelsLoaded) {
          alert("Face models not loaded yet.");
          return;
        }
        //await openCamera("adminVideo");
        const labeled = buildLabeledDescriptors();
        if (labeled.length === 0) {
          alert("No registered students ‚Äî register first");
          return;
        }
        faceMatcher = new faceapi.FaceMatcher(labeled, 0.5);
        sessionMarked = new Set();
        recognitionRunning = true;
        document.getElementById("faceStatus").textContent =
          "Recognition active";
        runRecognitionFrame();
      }

      function stopRecognitionLoop() {
        recognitionRunning = false;
        if (recognitionAnimationId) {
          cancelAnimationFrame(recognitionAnimationId);
          recognitionAnimationId = null;
        }
        document.getElementById("faceStatus").textContent = "";
        clearOverlay();
      }

      async function runRecognitionFrame() {
        if (!recognitionRunning) return;
        const video = document.getElementById("adminVideo");
        const overlay = document.getElementById("overlayCanvas");
        adjustOverlay();
        if (video.readyState < 2) {
          recognitionAnimationId = requestAnimationFrame(runRecognitionFrame);
          return;
        }

        try {
          const detections = await faceapi
            .detectAllFaces(video, new faceapi.TinyFaceDetectorOptions())
            .withFaceLandmarks()
            .withFaceDescriptors();
          drawDetectionsOnOverlay(video, overlay, detections);
          if (detections && detections.length && faceMatcher) {
            for (const det of detections) {
              const best = faceMatcher.findBestMatch(det.descriptor);
              if (best && best.label !== "unknown") {
                const usn = best.label;
                if (!sessionMarked.has(usn)) {
                  const subj = document.getElementById("adminAttSubject").value;
                  const period =
                    document.getElementById("adminAttPeriod").value || "1";
                  const now = new Date();
                  const date = now.toISOString().split("T")[0];
                  const time = now.toLocaleTimeString();
                  if (!studentData[usn].subjects[subj])
                    studentData[usn].subjects[subj] = [];
                  studentData[usn].subjects[subj].push({
                    date,
                    time,
                    period,
                    status: "Present",
                  });
                  saveStudentData();
                  sessionMarked.add(usn);
                  document.getElementById(
                    "faceStatus"
                  ).textContent = `Marked: ${studentData[usn].name} (${usn})`;
                  setTimeout(() => {
                    if (recognitionRunning)
                      document.getElementById("faceStatus").textContent =
                        "Recognition active";
                  }, 2000);
                }
              }
            }
            loadStudentList();
          }
        } catch (e) {
          console.error("Recognition error", e);
        }
        recognitionAnimationId = requestAnimationFrame(runRecognitionFrame);
      }

      function drawDetectionsOnOverlay(video, overlayCanvas, detections) {
        const ctx = overlayCanvas.getContext("2d");
        overlayCanvas.width = video.videoWidth;
        overlayCanvas.height = video.videoHeight;
        ctx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
        ctx.lineWidth = 2;
        ctx.font = "16px Arial";
        ctx.strokeStyle = "#00FF00";
        ctx.fillStyle = "#00FF00";
        for (const det of detections) {
          const box = det.detection.box;
          ctx.strokeRect(box.x, box.y, box.width, box.height);
          let label = "Unknown";
          if (faceMatcher) {
            const best = faceMatcher.findBestMatch(det.descriptor);
            if (best && best.label !== "unknown")
              label = studentData[best.label]
                ? `${studentData[best.label].name} (${best.label})`
                : best.label;
          }
          const textWidth = ctx.measureText(label).width;
          ctx.fillStyle = "rgba(0,0,0,0.6)";
          ctx.fillRect(box.x - 2, box.y - 20, textWidth + 8, 20);
          ctx.fillStyle = "#fff";
          ctx.fillText(label, box.x + 2, box.y - 5);
          ctx.fillStyle = "#00FF00";
        }
      }

      function adjustOverlay() {
        const video = document.getElementById("adminVideo");
        const overlay = document.getElementById("overlayCanvas");
        const rect = video.getBoundingClientRect();
      }

      function clearOverlay() {
        const overlay = document.getElementById("overlayCanvas");
        if (overlay) {
          const ctx = overlay.getContext("2d");
          ctx.clearRect(0, 0, overlay.width, overlay.height);
        }
      }

      function closeAdminCaptureModal() {
        const video = document.getElementById("adminVideo");
        closeModal("adminCaptureModal");

        stopRecognitionLoop();
      }

      async function forceRecognizeNow() {
        if (!recognitionRunning) await startRecognitionLoop();
        else {
          document.getElementById("faceStatus").textContent =
            "Forced check completed";
          setTimeout(() => {
            if (recognitionRunning)
              document.getElementById("faceStatus").textContent =
                "Recognition active";
          }, 1000);
        }
      }

      /* ===================== Modal, logout, search, admin dashboard etc remain unchanged ===================== */
      function showModal(id) {
        document
          .querySelectorAll(".modal")
          .forEach((m) => (m.style.display = "none"));
        document.getElementById(id).style.display = "block";
        if (id === "adminCaptureModal") {
          setTimeout(() => {
            adjustOverlay();
            startRecognitionLoop();
          }, 200);
        }
      }
      function closeModal(id) {
        document.getElementById(id).style.display = "none";
        if (id === "adminCaptureModal") {
          stopRecognitionLoop();
        }
      }
      window.onclick = (e) => {
        if (e.target.classList && e.target.classList.contains("modal")) {
          e.target.style.display = "none";
          if (e.target.id === "adminCaptureModal") stopRecognitionLoop();
        }
      };
      function logout() {
        currentStudent = null;
        stopRecognitionLoop();
        document.getElementById("homeButtons").style.display = "block";
        document.getElementById("studentDashboard").style.display = "none";
        document.getElementById("adminDashboard").style.display = "none";
      }

      /* Admin dashboard student list */
      function loadStudentList() {
        const list = document.getElementById("studentList");
        list.innerHTML = "";
        for (const [usn, s] of Object.entries(studentData)) {
          list.innerHTML += `<div class="student-item" data-usn="${usn}" onclick="showAdminStudent('${usn}')">${s.name} (${usn})</div>`;
        }
      }
      function showAdminStudent(usn) {
        const s = studentData[usn];
        //showStudentInfo();
        let html = `<img src="${s.photo}" style="width:100px;border-radius:50%;"><h4>${s.name}</h4>
            <p><b>Username:</b> ${s.uname} | <b>USN:</b> ${s.usn} | <b>Email:</b> ${s.email}<br><b>Phone:</b> ${s.phone} | <b>Course:</b> ${s.course} | <b>Sem:</b> ${s.semester}</p>
            <button onclick="deleteStudent('${usn}')" style="background:#ff4d4d; color:#fff; margin-bottom:10px;">Delete Student</button>`;
        for (const [sub, records] of Object.entries(s.subjects)) {
          html += `<div><div class="subject-header" onclick="toggleSubject(this)">${sub} ‚ñº</div>
      <table class="attendance-table"><thead><tr><th>Date</th><th>Time</th><th>Period</th><th>Status</th></tr></thead>
      <tbody>${records
        .map(
          (r) =>
            `<tr class="${r.status === "Present" ? "present" : "absent"}"><td>${
              r.date
            }</td><td>${r.time}</td><td>${r.period}</td><td>${
              r.status
            }</td></tr>`
        )
        .join("")}</tbody></table></div>`;
        }
        document.getElementById("adminStudentDetails").innerHTML = html;
      }

      function deleteStudent(usn) {
        if (confirm(`Delete ${studentData[usn].name} (${usn})?`)) {
          delete studentData[usn];
          saveStudentData();
          loadStudentList();
          document.getElementById("adminStudentDetails").innerHTML =
            "<h5>Select a student to view attendance</h5>";
          alert("Student deleted successfully!");
        }
      }

      function searchStudent() {
        const q = document.getElementById("searchInput").value.toLowerCase();
        document.querySelectorAll(".student-item").forEach((i) => {
          i.style.display = i.textContent.toLowerCase().includes(q)
            ? "flex"
            : "none";
        });
      }

      window.addEventListener("load", () => {
        loadStudentData();
      });
    </script>
  </body>
</html>
